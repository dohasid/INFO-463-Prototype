<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Keyboard Prototype Enhanced</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        button {
            margin-top: 6px;
        }

        #output {
            width: 1200px;
            height: 80px;
            border: 2px solid #aaa;
            margin-bottom: 5px;
            /* ↓↓ Was 20px — moved closer */
            padding: 10px;
            font-size: 28px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #shiftBtn {
            margin-top: 5px;
            /* optional: pulls it even closer */
            margin-bottom: 20px;
        }

        .keyboard {
            display: flex;
            flex-direction: column;
            width: 1400px;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .row {
            display: flex;
            justify-content: center;
            /* keeps rows centered */
            gap: 75px;
            /* controls horizontal spacing */
            margin-bottom: 70px;
            min-height: 100px;
            cursor: pointer;
        }


        .key {
            width: 80px;
            height: 80px;
            background: #eee;
            border: 1px solid #aaa;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            position: relative;
            cursor: pointer;
            user-select: none;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .key:hover {
            transform: scale(1.15);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .overlay-letter {
            position: absolute;
            width: 60px;
            height: 60px;
            background: pink;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }

        .overlay-letter:hover {
            transform: scale(1.4);
            z-index: 100;
        }

        .overlay-letter.most-likely {
            background-color: #ffeb3b;
        }

        .overlay-letter.top {
            top: 0;
            left: 50%;
            transform: translate(-50%, -100%);
        }

        .overlay-letter.left {
            top: 50%;
            left: 0;
            transform: translate(-100%, -50%);
        }

        .overlay-letter.right {
            top: 50%;
            left: 100%;
            transform: translate(0, -50%);
        }

        .overlay-letter.bottom {
            top: 100%;
            left: 50%;
            transform: translate(-50%, 0%);
        }

        .button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #ddd;
            border: 1px solid #999;
            border-radius: 5px;
            cursor: pointer;
            white-space: normal;
            line-height: 1.3;
            width: 300px;
            text-align: center;
        }

        #results {
            width: 1200px;
            margin-top: 15px;
            font-size: 18px;
        }

        #target {
            width: 1200px;
            margin: 10px 0;
            font-size: 22px;
            font-style: italic;
            color: #333;
        }

        #shiftBtn {
            width: 200px;
            padding: 8px;
            background: #ccc;
            border: 1px solid #777;
            border-radius: 5px;
            margin-bottom: 20px;
            cursor: pointer;
        }

        #shiftBtn.active {
            background: #999;
            color: white;
        }
    </style>
</head>

<body>

    <h2>Keyboard Prototype</h2>
    <p style="font-size:18px; color:#555; margin-bottom:15px;">
        To insert a space, simply click on the whitespace area between the keys.
    </p>
    <div id="output"></div>
    <div id="target"></div>

    <button id="shiftBtn">Shift (OFF)</button>

    <div>
        <button class="button" id="startBtn">Start Trial</button>
        <button class="button" id="finishBtn">Finish Trial</button>
    </div>

    <div id="results"></div>
    <div class="keyboard" id="keyboard"></div>

    <script>
        let isUpper = false;  // SHIFT STATE

        document.getElementById("shiftBtn").addEventListener("click", () => {
            isUpper = !isUpper;
            document.getElementById("shiftBtn").classList.toggle("active", isUpper);
            document.getElementById("shiftBtn").textContent = isUpper ? "Shift (ON)" : "Shift (OFF)";
            updateKeyboardCase();   // <-- REFRESH KEYS HERE
        });


        const keyboardLayout = [
            ["e", "c", "u", "p", "d", "a"],
            ["h", "f", "b", "k", "qjxz", "g"],
            ["l", "r", "v", "w", "m", "n"],
            ["i", "s", "y", "t", "o", "."]
        ];

        const overlayPredictions = {
            a: ["n", "r", "t", "l"], b: ["e", "r", "a", "o"], c: ["h", "o", "a", "e"],
            d: ["e", "i", "a", "o"], e: ["r", "s", "n", "d"], f: ["r", "o", "a", "i"],
            g: ["r", "a", "e", "u"], h: ["e", "a", "i", "o"], i: ["n", "t", "s", "c"],
            j: ["u", "a", "o", "e"], k: ["e", "i", "a", "o"], l: ["e", "i", "a", "o"],
            m: ["a", "e", "i", "o"], n: ["g", "d", "t", "c"], o: ["n", "r", "u", "l"],
            p: ["r", "l", "a", "e"], q: ["u"], r: ["e", "a", "i", "o"], s: ["t", "h", "e", "a"],
            t: ["h", "r", "o", "e"], u: ["r", "n", "s", "t"], v: ["e", "i", "a", "o"],
            w: ["h", "a", "e", "o"], x: ["t", "c", "a", "e"], y: ["o", "e", "a", "i"],
            z: ["e", "a", "i", "o"]
        };

        const qjxz = ["q", "j", "x", "z"];

        const targetSentences = [
            "She packed twelve blue pens in her small bag.",
            "Every bird sang sweet songs in the quiet dawn.",
            "They watched clouds drift across the golden sky.",
            "A clever mouse slipped past the sleepy cat.",
            "Green leaves danced gently in the warm breeze.",
            "He quickly wrote notes before the test began.",
            "The tall man wore boots made of soft leather.",
            "Old clocks ticked loudly in the silent room.",
            "She smiled while sipping tea on the front porch.",
            "We found a hidden path behind the old barn.",
            "Sunlight streamed through cracks in the ceiling.",
            "Dogs barked at shadows moving through the yard.",
            "Rain tapped softly against the window glass.",
            "Bright stars twinkled above the quiet valley.",
            "He tied the package with ribbon and string.",
            "A sudden breeze blew papers off the desk.",
            "The curious child opened every single drawer.",
            "Fresh apples fell from the heavy tree limbs.",
            "The artist painted scenes from her memory.",
            "They danced all night under the glowing moon."
        ];

        let keystrokes = [];
        let typed = "";
        let trialActive = false;
        let startTime = null;
        let targetString = "";

        const keyboardDiv = document.getElementById("keyboard");

        function applyCase(letter) {
            return isUpper ? letter.toUpperCase() : letter.toLowerCase();
        }

        function updateKeyboardCase() {
            document.querySelectorAll(".key").forEach(key => {
                const letter = key.dataset.letter;
                key.textContent = applyCase(letter);
            });
        }


        function recordKeystroke(letter) {
            if (!trialActive) return;
            if (!startTime) startTime = performance.now();

            const outputLetter = letter === " " ? "␣" : applyCase(letter);

            keystrokes.push({ letter: outputLetter, time: performance.now() });
            typed += outputLetter;

            document.getElementById("output").textContent = typed;
        }

        // space on click in gaps
        keyboardDiv.addEventListener("click", e => {
            if (!e.target.classList.contains("key") &&
                !e.target.classList.contains("overlay-letter")) {
                recordKeystroke(" ");
            }
        });

        // --- BUILD KEYBOARD ---
        keyboardLayout.forEach(row => {
            const rowDiv = document.createElement("div");
            rowDiv.className = "row";

            row.forEach(letter => {
                const key = document.createElement("div");
                key.className = "key";
                key.dataset.letter = letter;
                key.textContent = applyCase(letter);

                let overlay;

                function showOverlay(arr, key) {
                    // Remove any existing overlays from other keys
                    document.querySelectorAll(".overlay").forEach(o => o.remove());

                    const overlay = document.createElement("div");
                    overlay.className = "overlay";
                    key.appendChild(overlay);

                    const pos = ["top", "left", "right", "bottom"];
                    arr.forEach((l, i) => {
                        const div = document.createElement("div");
                        div.className = `overlay-letter ${pos[i] || "top"}`;
                        if (i === 0) div.classList.add("most-likely");
                        div.textContent = applyCase(l);
                        div.addEventListener("click", e => {
                            e.stopPropagation();
                            recordKeystroke(l);
                        });
                        overlay.appendChild(div);
                    });
                }


                key.addEventListener("click", () => {
                    if (letter === ".") {
                        recordKeystroke(".");
                        return;
                    }

                    if (letter === "qjxz") {
                        showOverlay(qjxz, key);

                    } else {
                        const preds = overlayPredictions[letter] || [];
                        showOverlay(preds, key);

                        recordKeystroke(letter);
                    }
                });

                rowDiv.appendChild(key);
            });

            keyboardDiv.appendChild(rowDiv);
        });

        // START BUTTON
        document.getElementById("startBtn").addEventListener("click", () => {
            typed = "";
            keystrokes = [];
            trialActive = true;
            startTime = null;

            const i = Math.floor(Math.random() * targetSentences.length);
            targetString = targetSentences[i];

            document.getElementById("output").textContent = "";
            document.getElementById("target").textContent = "Target: " + targetString;

            document.getElementById("startBtn").disabled = true;
            document.getElementById("results").innerHTML = "";
        });

        // FINISH BUTTON
        document.getElementById("finishBtn").addEventListener("click", () => {
            trialActive = false;
            document.getElementById("startBtn").disabled = false;

            if (keystrokes.length === 0) return;

            const end = keystrokes[keystrokes.length - 1].time;
            const durationMin = (end - startTime) / 60000;

            const typedClean = typed.replace(/␣/g, "");
            const targetClean = targetString.replace(/\s/g, "");

            const WPM = (typedClean.length / 5) / durationMin;

            const MSD = levenshtein(typedClean, targetClean);

            document.getElementById("results").innerHTML = `
        <h3>Results</h3>
        <p>Target: ${targetString}</p>
        <p>Typed: ${typed}</p>
        <p>WPM: ${WPM.toFixed(2)}</p>
        <p>MSD: ${MSD}</p>
        <p>Duration (min): ${durationMin.toFixed(3)}</p>
        <p style="color:blue;"><strong>Trial finished!</strong></p>
    `;
        });

        // LEVENSHTEIN
        function levenshtein(a, b) {
            const m = [];
            for (let i = 0; i <= b.length; i++) m[i] = [i];
            for (let j = 0; j <= a.length; j++) m[0][j] = j;

            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    m[i][j] = b[i - 1] === a[j - 1]
                        ? m[i - 1][j - 1]
                        : Math.min(
                            m[i - 1][j] + 1,
                            m[i][j - 1] + 1,
                            m[i - 1][j - 1] + 1
                        );
                }
            }
            return m[b.length][a.length];
        }
    </script>

</body>

</html>