<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Keyboard Prototype Enhanced</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        button {
            margin-top: 6px;
        }

        #output {
            width: 1200px;
            height: 80px;
            border: 2px solid #aaa;
            margin-bottom: 20px;
            padding: 10px;
            font-size: 28px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .keyboard {
            display: flex;
            flex-direction: column;
            width: 1400px;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 70px;
            min-height: 100px;
            cursor: pointer;
            /* So gaps can be clicked */
        }

        .key {
            width: 80px;
            height: 80px;
            background: #eee;
            border: 1px solid #aaa;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            position: relative;
            cursor: pointer;
            user-select: none;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .key:hover {
            transform: scale(1.15);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .overlay-letter {
            position: absolute;
            width: 60px;
            height: 60px;
            background: pink;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }

        .overlay-letter:hover {
            transform: scale(1.4);
            z-index: 100;
        }

        .overlay-letter.most-likely {
            background-color: #ffeb3b;
        }

        .overlay-letter.top {
            top: 0;
            left: 50%;
            transform: translate(-50%, -100%);
        }

        .overlay-letter.left {
            top: 50%;
            left: 0;
            transform: translate(-100%, -50%);
        }

        .overlay-letter.right {
            top: 50%;
            left: 100%;
            transform: translate(0, -50%);
        }

        .overlay-letter.bottom {
            top: 100%;
            left: 50%;
            transform: translate(-50%, 0%);
        }

        .button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #ddd;
            border: 1px solid #999;
            border-radius: 5px;
            cursor: pointer;
            white-space: normal;
            line-height: 1.3;
            width: 300px;
            text-align: center;
        }

        .button:hover {
            background-color: #ccc;
        }

        #results {
            width: 1200px;
            margin-top: 15px;
            font-size: 18px;
        }

        #target {
            width: 1200px;
            margin: 10px 0;
            font-size: 22px;
            font-style: italic;
            color: #333;
        }
    </style>
</head>

<body>

    <h2>Keyboard Prototype</h2>

    <div id="output"></div>
    <div id="target"></div>

    <div>
        <button class="button" id="startBtn">Start Trial</button>
        <button class="button" id="finishBtn">Finish Trial</button>
    </div>

    <div id="results"></div>
    <div class="keyboard" id="keyboard"></div>

    <script>
        const keyboardLayout = [
            ["E", "C", "U", "P", "D", "A"],
            ["N", "F", "B", "K", "QJXZ", "G"],
            ["L", "R", "V", "W", "M", "H"],
            ["I", "S", "Y", "T", "O", "."]
        ];

        const overlayPredictions = {
            A: ["N", "R", "T", "L"], B: ["E", "R", "A", "O"], C: ["H", "O", "A", "E"],
            D: ["E", "I", "A", "O"], E: ["R", "S", "N", "D"], F: ["R", "O", "A", "I"],
            G: ["R", "A", "E", "U"], H: ["E", "A", "I", "O"], I: ["N", "T", "S", "C"],
            J: ["U", "A", "O", "E"], K: ["E", "I", "A", "O"], L: ["E", "I", "A", "O"],
            M: ["A", "E", "I", "O"], N: ["G", "D", "T", "C"], O: ["N", "R", "U", "L"],
            P: ["R", "L", "A", "E"], Q: ["U"], R: ["E", "A", "I", "O"], S: ["T", "H", "E", "A"],
            T: ["H", "R", "O", "E"], U: ["R", "N", "S", "T"], V: ["E", "I", "A", "O"], W: ["H", "A", "E", "O"],
            X: ["T", "C", "A", "E"], Y: ["O", "E", "A", "I"], Z: ["E", "A", "I", "O"]
        };
        const qjxzOverlay = ["Q", "J", "X", "Z"];

        const targetSentences = [
            "She packed twelve blue pens in her small bag.",
            "Every bird sang sweet songs in the quiet dawn.",
            "They watched clouds drift across the golden sky.",
            "A clever mouse slipped past the sleepy cat.",
            "Green leaves danced gently in the warm breeze.",
            "He quickly wrote notes before the test began.",
            "The tall man wore boots made of soft leather.",
            "Old clocks ticked loudly in the silent room.",
            "She smiled while sipping tea on the front porch.",
            "We found a hidden path behind the old barn.",
            "Sunlight streamed through cracks in the ceiling.",
            "Dogs barked at shadows moving through the yard.",
            "Rain tapped softly against the window glass.",
            "Bright stars twinkled above the quiet valley.",
            "He tied the package with ribbon and string.",
            "A sudden breeze blew papers off the desk.",
            "The curious child opened every single drawer.",
            "Fresh apples fell from the heavy tree limbs.",
            "The artist painted scenes from her memory.",
            "They danced all night under the glowing moon."
        ];

        let keystrokes = [];
        let typed = "";
        let trialActive = false;
        let startTime = null;
        let targetString = "";

        const keyboardDiv = document.getElementById("keyboard");
        const targetDiv = document.getElementById("target");

        function recordKeystroke(letter) {
            if (!trialActive) return;
            if (!startTime) startTime = performance.now();
            keystrokes.push({ letter, time: performance.now() });
            typed += letter === " " ? "␣" : letter;
            document.getElementById("output").textContent = typed;
        }

        // Click in vertical gaps
        keyboardDiv.addEventListener("click", (e) => {
            if (!e.target.classList.contains("key") && !e.target.classList.contains("overlay-letter")) {
                recordKeystroke(" ");
            }
        });

        keyboardLayout.forEach(row => {
            const rowDiv = document.createElement("div");
            rowDiv.className = "row";

            // Click in horizontal gaps
            // rowDiv.addEventListener("click", (e) => {
            //     if (!e.target.classList.contains("key")) {
            //         recordKeystroke(" ");
            //     }
            // });

            row.forEach(letter => {
                const key = document.createElement("div");
                key.className = "key";
                key.textContent = letter;

                let overlay;
                function showOverlay(lettersArr) {
                    if (overlay) overlay.remove();
                    overlay = document.createElement("div");
                    overlay.className = "overlay";
                    key.appendChild(overlay);
                    const edgeClasses = ["top", "left", "right", "bottom"];
                    lettersArr.forEach((l, i) => {
                        const letterDiv = document.createElement("div");
                        letterDiv.className = `overlay-letter ${edgeClasses[i] || "top"}`;
                        if (i === 0) letterDiv.classList.add("most-likely");
                        letterDiv.textContent = l;
                        letterDiv.addEventListener("click", (e) => {
                            e.stopPropagation();
                            recordKeystroke(l);
                        });
                        overlay.appendChild(letterDiv);
                    });
                    key.addEventListener("mouseleave", () => {
                        if (overlay) overlay.remove();
                    }, { once: true });
                }

                key.addEventListener("click", () => {
                    if (letter === ".") {
                        recordKeystroke(".");
                        return;
                    }

                    if (letter === "QJXZ") {
                        showOverlay(qjxzOverlay);
                    } else {
                        const lettersArr = overlayPredictions[letter] || [];
                        showOverlay(lettersArr);
                        recordKeystroke(letter);
                    }
                });

                rowDiv.appendChild(key);
            });

            keyboardDiv.appendChild(rowDiv);
        });

        document.getElementById("startBtn").addEventListener("click", () => {
            typed = "";
            keystrokes = [];
            trialActive = true;
            startTime = null;

            const randomIndex = Math.floor(Math.random() * targetSentences.length);
            targetString = targetSentences[randomIndex];

            document.getElementById("output").textContent = "";
            targetDiv.textContent = `Target: ${targetString}`;

            document.getElementById("startBtn").disabled = true;
            document.getElementById("results").innerHTML = "";
        });

        document.getElementById("finishBtn").addEventListener("click", () => {
            trialActive = false;

            document.getElementById("startBtn").disabled = false;

            if (keystrokes.length === 0) return;

            const endTime = keystrokes[keystrokes.length - 1].time;
            const durationMin = (endTime - startTime) / 60000;
            const grossWPM = (typed.replace(/␣/g, "").length / 5) / durationMin;
            const msd = levenshtein(typed.replace(/␣/g, ""), targetString.replace(/\s/g, ""));

            document.getElementById("results").innerHTML = `
                <h3>Results</h3>
                <p>Target: ${targetString}</p>
                <p>Typed: ${typed}</p>
                <p>WPM: ${grossWPM.toFixed(2)}</p>
                <p>MSD: ${msd}</p>
                <p>Duration (min): ${durationMin.toFixed(3)}</p>
                <p style="color:blue;"><strong>Trial finished!</strong></p>
            `;
        });

        function levenshtein(a, b) {
            const matrix = [];
            for (let i = 0; i <= b.length; i++) matrix[i] = [i];
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    matrix[i][j] = b[i - 1] === a[j - 1]
                        ? matrix[i - 1][j - 1]
                        : Math.min(matrix[i - 1][j] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j - 1] + 1);
                }
            }
            return matrix[b.length][a.length];
        }
    </script>

</body>

</html>